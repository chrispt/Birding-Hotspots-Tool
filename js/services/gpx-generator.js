/**
 * GPX Generator Service
 * Generates GPX 1.1 files for GPS navigation
 */

/**
 * Escape XML special characters
 * @param {string} str - String to escape
 * @returns {string} Escaped string
 */
function escapeXml(str) {
    if (!str) return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
}

/**
 * Generate GPX file from itinerary data
 * @param {Object} itinerary - Itinerary data from buildItinerary()
 * @param {Object} options - Generation options
 * @param {string} options.name - Name of the route (default: 'Birding Itinerary')
 * @param {string} options.description - Description of the route
 * @returns {string} GPX XML content
 */
export function generateGPX(itinerary, options = {}) {
    const {
        name = 'Birding Itinerary',
        description = 'Optimized birding route generated by Birding Hotspots Finder'
    } = options;

    const now = new Date().toISOString();
    const stops = itinerary.stops;

    // Build waypoints XML
    const waypointsXml = stops.map((stop, index) => {
        const stopName = stop.type === 'start' ? 'Start' :
            stop.type === 'end' ? 'End' :
                `${index}. ${stop.name}`;

        const stopDesc = stop.type === 'hotspot' ?
            `Birding hotspot with ${stop.speciesCount} species observed recently.` :
            stop.address || '';

        return `  <wpt lat="${stop.lat}" lon="${stop.lng}">
    <name>${escapeXml(stopName)}</name>
    <desc>${escapeXml(stopDesc)}</desc>
    <sym>${stop.type === 'hotspot' ? 'Flag, Green' : 'Pin, Red'}</sym>
  </wpt>`;
    }).join('\n');

    // Build route XML (ordered waypoints)
    const routePointsXml = stops.map((stop, index) => {
        const stopName = stop.type === 'start' ? 'Start' :
            stop.type === 'end' ? 'End' :
                `${index}. ${stop.name}`;

        return `    <rtept lat="${stop.lat}" lon="${stop.lng}">
      <name>${escapeXml(stopName)}</name>
    </rtept>`;
    }).join('\n');

    // Build track from geometry if available
    let trackXml = '';
    if (itinerary.geometry && itinerary.geometry.coordinates) {
        const trackPoints = itinerary.geometry.coordinates
            .map(coord => `      <trkpt lat="${coord[1]}" lon="${coord[0]}"></trkpt>`)
            .join('\n');

        trackXml = `
  <trk>
    <name>${escapeXml(name)} Track</name>
    <trkseg>
${trackPoints}
    </trkseg>
  </trk>`;
    }

    // Build full GPX document
    const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1"
     creator="Birding Hotspots Finder"
     xmlns="http://www.topografix.com/GPX/1/1"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>${escapeXml(name)}</name>
    <desc>${escapeXml(description)}</desc>
    <time>${now}</time>
  </metadata>

${waypointsXml}

  <rte>
    <name>${escapeXml(name)}</name>
    <desc>${escapeXml(description)}</desc>
${routePointsXml}
  </rte>
${trackXml}
</gpx>`;

    return gpx;
}

/**
 * Download GPX file
 * @param {string} gpxContent - GPX XML content
 * @param {string} filename - Filename without extension
 */
export function downloadGPX(gpxContent, filename = 'birding-itinerary') {
    const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `${filename}.gpx`;
    link.style.display = 'none';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);
}
